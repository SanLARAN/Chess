<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–®–∞—Ö–º–∞—Ç—ã —Å –ö–∞—Ä—Ç–∞–º–∏</title>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ chessboard.js -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
  />

  <style>
    body {
      font-family: sans-serif;
      background: #f2f2f2;
      text-align: center;
      padding-top: 20px;
    }

    h2 {
      margin-bottom: 10px;
    }

    #board {
      width: 400px;
      margin: 0 auto 10px;
      /* –ß—Ç–æ–±—ã –¥–æ—Å–∫–∞ –Ω–µ ‚Äú—Å—Ö–ª–æ–ø–Ω—É–ª–∞—Å—å‚Äù */
      border: 2px solid #333;
      box-sizing: border-box;
    }

    #status {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0;
    }

    button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .hand {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .card {
      width: 150px;
      background: #ffffff;
      border: 2px solid #333;
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .card:hover {
      background-color: #fafafa;
      transform: translateY(-2px);
    }

    .selected-card {
      border-color: #e74c3c;
      background-color: #ffecec;
    }
  </style>
</head>
<body>

  <h2>‚ôüÔ∏è –®–∞—Ö–º–∞—Ç—ã —Å –ö–∞—Ä—Ç–∞–º–∏</h2>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ—Å–∫–∏ -->
  <div id="board"></div>

  <!-- –°—Ç–∞—Ç—É—Å (—á–µ–π —Ö–æ–¥) -->
  <div id="status">–•–æ–¥ –±–µ–ª—ã—Ö</div>

  <!-- –ö–Ω–æ–ø–∫–∞ –î–æ–±–æ—Ä–∞ –ö–∞—Ä—Ç—ã -->
  <button onclick="drawCard()">–í–∑—è—Ç—å –∫–∞—Ä—Ç—É</button>

  <!-- –†—É–∫–∞ (—Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç) -->
  <div class="hand" id="hand"></div>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º chess.js (–ª–æ–≥–∏–∫–∞ —à–∞—Ö–º–∞—Ç) -->
  <script src="https://unpkg.com/chess.js@0.12.0/chess.min.js"></script>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º chessboard.js (UI —à–∞—Ö–º–∞—Ç–Ω–æ–π –¥–æ—Å–∫–∏) -->
  <script src="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

  <script>
    // === 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞—Ö–º–∞—Ç–Ω–æ–π –ª–æ–≥–∏–∫–∏ ===
    const game = new Chess();
    let currentTurn = 'w';      // 'w' –∏–ª–∏ 'b'
    let extraMove = false;      // –µ—Å–ª–∏ true ‚Äî –∏–≥—Ä–æ–∫ –¥–µ–ª–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ö–æ–¥

    // === 2. State –¥–ª—è –∫–∞—Ä—Ç –∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ ===
    const playerState = {
      hand: [],             // –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç –Ω–∞ —Ä—É–∫–µ
      frozenPieces: {}      // { 'e7': 1 } ‚Äî –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ –∫–ª–µ—Ç–∫–∏
    };

    // === 3. –ü—É–ª –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ä—Ç (3 –ø—Ä–∏–º–µ—Ä–∞) ===
    const cardPool = [
      {
        id: "freeze",
        name: "‚ùÑ –ó–∞–º–æ—Ä–æ–∑–∫–∞",
        description: "–ö–ª–∏–∫–Ω–∏ –ø–æ —Ñ–∏–≥—É—Ä–µ –≤—Ä–∞–≥–∞ ‚Äî –æ–Ω–∞ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç 1 —Ö–æ–¥.",
        // –î–ª—è –∫–∞—Ä—Ç—ã ¬´freeze¬ª –º—ã —Ö—Ä–∞–Ω–∏–º –≤ playerState.frozenPieces[square] = 1
        effect: (targetSquare) => {
          if (!game.get(targetSquare) || game.get(targetSquare).color === currentTurn) {
            alert("–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –≤—Ä–∞–∂–µ—Å–∫—É—é —Ñ–∏–≥—É—Ä—É!");
            return false;
          }
          playerState.frozenPieces[targetSquare] = 1;
          alert(`–§–∏–≥—É—Ä–∞ –Ω–∞ ${targetSquare} –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞!`);
          return true;
        }
      },
      {
        id: "teleport",
        name: "üåÄ –¢–µ–ª–µ–ø–æ—Ä—Ç",
        description: "–ö–ª–∏–∫–Ω–∏ –ø–æ —Å–≤–æ–µ–π —Ñ–∏–≥—É—Ä–µ, –∑–∞—Ç–µ–º ‚Äî –ø–æ –ø—É—Å—Ç–æ–π –∫–ª–µ—Ç–∫–µ.",
        // effect –ø–æ–ª—É—á–∞–µ—Ç –º–∞—Å—Å–∏–≤ [—Å —á–µ–≥–æ, –∫—É–¥–∞]
        effect: ([from, to]) => {
          const piece = game.get(from);
          if (!piece || piece.color !== currentTurn) {
            alert("–≠—Ç–æ –Ω–µ –≤–∞—à–∞ —Ñ–∏–≥—É—Ä–∞!");
            return false;
          }
          if (game.get(to)) {
            alert("–ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞!");
            return false;
          }
          game.remove(from);
          game.put(piece, to);
          board.position(game.fen());
          return true;
        }
      },
      {
        id: "double_move",
        name: "‚ö° –î–≤–æ–π–Ω–æ–π —Ö–æ–¥",
        description: "–°–¥–µ–ª–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ö–æ–¥ —Å—Ä–∞–∑—É.",
        effect: () => {
          extraMove = true;
          alert("–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ö–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!");
          return true;
        }
      }
    ];


    // === 4. –°–æ–∑–¥–∞—ë–º –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º —à–∞—Ö–º–∞—Ç–Ω—É—é –¥–æ—Å–∫—É ===
    // onDrop ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç —Ñ–∏–≥—É—Ä—É
    // onSquareClick ‚Äî –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ –ª—é–±—É—é –∫–ª–µ—Ç–∫—É
    const board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDrop: onDrop,
      onSquareClick: onSquareClick
    });

    // === 5. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ö–æ–¥–∞ —Ñ–∏–≥—É—Ä—ã ===
    function onDrop(source, target) {
      // –ï—Å–ª–∏ –Ω–∞ –∫–ª–µ—Ç–∫–µ source –µ—Å—Ç—å –∑–∞–º–æ—Ä–æ–∑–∫–∞ ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ–º —Ö–æ–¥
      if (playerState.frozenPieces[source]) {
        alert("–≠—Ç–∞ —Ñ–∏–≥—É—Ä–∞ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞ –∏ –Ω–µ –º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è.");
        return 'snapback';
      }

      // –î–µ–ª–∞–µ–º —Ö–æ–¥ —á–µ—Ä–µ–∑ chess.js
      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) {
        // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ö–æ–¥ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –º–µ—Å—Ç–æ
        return 'snapback';
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º UI –∏ —Å—Ç–∞—Ç—É—Å
      board.position(game.fen());
      updateStatus();

      // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ ¬´–¥–≤–æ–π–Ω–æ–π —Ö–æ–¥¬ª –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Äî –¥–∞—ë–º –≤—Ç–æ—Ä–æ–π —Ö–æ–¥, –∏–Ω–∞—á–µ –º–µ–Ω—è–µ–º —Ö–æ–¥
      if (!extraMove) {
        switchTurn();
      } else {
        extraMove = false;
      }
    }

    // === 6. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–ª–µ—Ç–∫–µ (–¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç) ===
    // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤—ã–±—Ä–∞–ª –∫–∞—Ä—Ç—É, —Ç–æ —Å—é–¥–∞ –ø—Ä–∏–ª–µ—Ç–∏—Ç —Å–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞ –ø–æ –∫–ª–µ—Ç–∫–µ.
    function onSquareClick(square) {
      // –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ä—Ç–∞ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      if (selectedCardIndex === null) return;

      const card = playerState.hand[selectedCardIndex];

      // –ö–∞—Ä—Ç–∞ ¬´–ó–∞–º–æ—Ä–æ–∑–∫–∞¬ª: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ –≤—Ä–∞–∂–µ—Å–∫–æ–π —Ñ–∏–≥—É—Ä–µ
      if (card.id === "freeze") {
        const success = card.effect(square);
        if (success) {
          // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏
          playerState.hand.splice(selectedCardIndex, 1);
          selectedCardIndex = null;
          renderHand();
        }
        return;
      }

      // –ö–∞—Ä—Ç–∞ ¬´–¢–µ–ª–µ–ø–æ—Ä—Ç¬ª: –¥–≤–∞ –∫–ª–∏–∫–∞ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø–æ —Å–≤–æ–µ–π —Ñ–∏–≥—É—Ä–µ, –ø–æ—Ç–æ–º –ø–æ –ø—É—Å—Ç–æ–π –∫–ª–µ—Ç–∫–µ
      if (card.id === "teleport") {
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫
        if (cardTargetStep === 0) {
          // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞—à–∞ —Ñ–∏–≥—É—Ä–∞
          const piece = game.get(square);
          if (!piece || piece.color !== currentTurn) {
            alert("–ö–ª–∏–∫–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –ø–æ —Å–≤–æ–µ–π —Ñ–∏–≥—É—Ä–µ.");
            return;
          }
          cardTargetData[0] = square;
          cardTargetStep = 1;
          alert("–¢–µ–ø–µ—Ä—å –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –ø—É—Å—Ç–æ–π –∫–ª–µ—Ç–∫–µ, –∫—É–¥–∞ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.");
          return;
        } else if (cardTargetStep === 1) {
          // –í—Ç–æ—Ä–æ–π –∫–ª–∏–∫ ‚Äî –ø—É—Å—Ç–∞—è –∫–ª–µ—Ç–∫–∞
          const to = square;
          if (game.get(to)) {
            alert("–ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é.");
            return;
          }
          cardTargetData[1] = to;
          // –ü—Ä–∏–º–µ–Ω–∏–º —ç—Ñ—Ñ–µ–∫—Ç
          const success = card.effect(cardTargetData);
          if (success) {
            playerState.hand.splice(selectedCardIndex, 1);
            selectedCardIndex = null;
            cardTargetStep = 0;
            cardTargetData = [];
            renderHand();
          } else {
            // –ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            selectedCardIndex = null;
            cardTargetStep = 0;
            cardTargetData = [];
            renderHand();
          }
          return;
        }
      }

      // –ö–∞—Ä—Ç–∞ ¬´–î–≤–æ–π–Ω–æ–π —Ö–æ–¥¬ª: –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–±–æ—Ä–∞ –∫–ª–µ—Ç–∫–∏
      if (card.id === "double_move") {
        const success = card.effect();
        if (success) {
          playerState.hand.splice(selectedCardIndex, 1);
          selectedCardIndex = null;
          renderHand();
        }
        return;
      }
    }

    // === 7. –°–º–µ–Ω–∞ —Ö–æ–¥–∞ –∏ —É–º–µ–Ω—å—à–µ–Ω–∏–µ ‚Äú–∑–∞–º–æ—Ä–æ–∑–æ–∫‚Äù ===
    function switchTurn() {
      currentTurn = currentTurn === 'w' ? 'b' : 'w';

      // –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–æ–¥–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –∫–ª–µ—Ç–∫–∏ –∑–∞–º–æ—Ä–æ–∂–µ–Ω—ã
      for (const sq in playerState.frozenPieces) {
        playerState.frozenPieces[sq]--;
        if (playerState.frozenPieces[sq] <= 0) {
          delete playerState.frozenPieces[sq];
        }
      }

      updateStatus();
    }

    // === 8. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç—É—Å–∞ (—á–µ–π —Ö–æ–¥ / –∫–æ–Ω–µ—Ü –∏–≥—Ä—ã) ===
    function updateStatus() {
      const statusEl = document.getElementById('status');
      if (game.game_over()) {
        if (game.in_checkmate()) {
          statusEl.textContent = '–ú–∞—Ç! –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.';
        } else if (game.in_draw()) {
          statusEl.textContent = '–ù–∏—á—å—è! –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.';
        } else {
          statusEl.textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.';
        }
      } else {
        statusEl.textContent = `–•–æ–¥ ${currentTurn === 'w' ? '–±–µ–ª—ã—Ö' : '—á—ë—Ä–Ω—ã—Ö'}`;
      }
    }

    // === 9. –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–∞—Ä—Ç: –¥–æ–±–æ—Ä, —Ä–µ–Ω–¥–µ—Ä —Ä—É–∫–∏, –≤—ã–±–æ—Ä –∫–∞—Ä—Ç—ã ===
    let selectedCardIndex = null;   // –∏–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã –≤ —Ä—É–∫–µ
    let cardTargetStep = 0;         // –¥–ª—è –∫–∞—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–µ–Ω 2-—ç—Ç–∞–ø–Ω—ã–π –≤—ã–±–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, teleport)
    let cardTargetData = [];        // –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—ã–±–æ—Ä–∞

    // –ù–∞–∂–∞–ª–∏ "–í–∑—è—Ç—å –∫–∞—Ä—Ç—É" ‚Äî —Ä–∞–Ω–¥–æ–º–∏–º –∏–∑ cardPool
    function drawCard() {
      const cardCopy = JSON.parse(JSON.stringify(cardPool[Math.floor(Math.random() * cardPool.length)]));
      playerState.hand.push(cardCopy);
      renderHand();
    }

    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å—é —Ä—É–∫—É (—Å–ø–∏—Å–æ–∫ .card)
    function renderHand() {
      const handEl = document.getElementById('hand');
      handEl.innerHTML = '';

      playerState.hand.forEach((card, idx) => {
        const div = document.createElement('div');
        div.className = 'card' + (selectedCardIndex === idx ? ' selected-card' : '');
        div.innerHTML = `<b>${card.name}</b><br><small>${card.description}</small>`;
        div.onclick = () => selectCard(idx);
        handEl.appendChild(div);
      });
    }

    // –í—ã–±—Ä–∞–ª–∏ –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏
    function selectCard(index) {
      // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–µ ‚Äî –æ—Ç–º–µ–Ω—è–µ–º –≤—ã–±–æ—Ä
      if (selectedCardIndex === index) {
        selectedCardIndex = null;
        cardTargetStep = 0;
        cardTargetData = [];
      } else {
        // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—É—é
        selectedCardIndex = index;
        cardTargetStep = 0;
        cardTargetData = [];
      }
      renderHand();
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    updateStatus();
  </script>
</body>
</html>
