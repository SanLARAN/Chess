<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Шахматы с картами</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    p {
      font-size: 1.1em;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Шахматы с картами — Механика игры</h1>
  <p>Откройте консоль браузера для просмотра логов игры.</p>
  
  <script>
    // Определяем веса для карт по редкости
    const rarityWeights = {
      "Обычная": 50,
      "Редкая": 30,
      "Эпическая": 15,
      "Легендарная": 5
    };

    // Класс карточки
    class Card {
      constructor(name, rarity, effect) {
        this.name = name;
        this.rarity = rarity;
        this.effect = effect; // Функция: (game, player, target) => { ... }
      }

      use(game, player, target) {
        console.log(`${player.name} использует карту: ${this.name}`);
        this.effect(game, player, target);
      }
    }

    // Определяем 15 карт с эффектами (эффекты – упрощённые заглушки)
    const cardPool = [
      new Card("Стальной Щит", "Обычная", (game, player, target) => {
          if (target) {
             target.shield = true;
             console.log(`Фигура ${target.type} теперь под защитой на один ход.`);
          } else {
             console.log("Не выбрана цель для использования «Стального Щита».");
          }
      }),
      new Card("Ветер Перемен", "Обычная", (game, player, target) => {
          console.log("Используется «Ветер Перемен»: игрок получает дополнительный ход.");
          // Дополнительный ход: не переключаем текущего игрока.
          game.currentPlayerIndex = game.players.indexOf(player);
      }),
      new Card("Острый Клинок", "Обычная", (game, player, target) => {
          if (target && target.player !== player) {
             console.log(`«Острым Клинком» удалена фигура ${target.type} противника.`);
             // Удаляем фигуру с доски
             let pos = target.position;
             game.board.grid[pos.y][pos.x] = null;
          } else {
             console.log("Нет подходящей цели для «Острого Клинка».");
          }
      }),
      new Card("Теневой Манёвр", "Редкая", (game, player, target) => {
          if (target && target.player === player) {
              target.invisible = true;
              console.log(`Фигура ${target.type} становится невидимой на один ход.`);
          } else {
              console.log("Цель должна принадлежать игроку для «Теневого Манёвра».");
          }
      }),
      new Card("Эхо Возмездия", "Редкая", (game, player, target) => {
          console.log("«Эхо Возмездия» активировано: при следующем захвате фигуры её эффектом можно восстановить фигуру (заглушка).");
          // Здесь можно добавить дополнительное состояние, чтобы восстановить фигуру при захвате.
      }),
      new Card("Смена Позиции", "Редкая", (game, player, target) => {
          // Ожидаем объект { piece1, piece2 } с двумя выбранными фигурами
          if (target && target.piece1 && target.piece2) {
             let pos1 = target.piece1.position;
             let pos2 = target.piece2.position;
             game.board.grid[pos1.y][pos1.x] = target.piece2;
             game.board.grid[pos2.y][pos2.x] = target.piece1;
             target.piece1.position = pos2;
             target.piece2.position = pos1;
             console.log(`Позиции фигур ${target.piece1.type} и ${target.piece2.type} изменены.`);
          } else {
             console.log("Необходимо выбрать две фигуры для «Смены Позиции».");
          }
      }),
      new Card("Пламенный Взрыв", "Эпическая", (game, player, target) => {
          if (target) {
             let x = target.position.x;
             let y = target.position.y;
             console.log(`«Пламенный Взрыв»: уничтожение фигур вокруг (${x}, ${y}).`);
             const directions = [
                {dx: -1, dy: -1}, {dx: 0, dy: -1}, {dx: 1, dy: -1},
                {dx: -1, dy: 0},                {dx: 1, dy: 0},
                {dx: -1, dy: 1},  {dx: 0, dy: 1},  {dx: 1, dy: 1}
             ];
             directions.forEach(dir => {
               let newX = x + dir.dx;
               let newY = y + dir.dy;
               if (newX >= 0 && newX < 8 && newY >= 0 && newY < 8 && game.board.grid[newY][newX] != null) {
                 console.log(`Фигура ${game.board.grid[newY][newX].type} уничтожена.`);
                 game.board.grid[newY][newX] = null;
               }
             });
          } else {
             console.log("Не выбрана цель для «Пламенного Взрыва».");
          }
      }),
      new Card("Ледяное Зачарование", "Эпическая", (game, player, target) => {
          if (target && target.player !== player) {
             target.frozen = true;
             console.log(`Фигура ${target.type} заморожена и не сможет двигаться в следующий ход.`);
          } else {
             console.log("Выберите вражескую фигуру для «Ледяного Зачарования».");
          }
      }),
      new Card("Светлая Аура", "Эпическая", (game, player, target) => {
          if (target && target.player === player) {
             console.log(`Фигура ${target.type} усилена «Светлой Аурой»: шанс захвата снижен.`);
             target.protected = true; // Дополнительный флаг защиты
          } else {
             console.log("Выберите свою фигуру для «Светлой Ауры».");
          }
      }),
      new Card("Вспышка Молнии", "Легендарная", (game, player, target) => {
          // Ожидаем объект { piece, destination } – фигура и целевая свободная клетка
          if (target && target.piece && target.destination && target.piece.player === player) {
              if (game.board.grid[target.destination.y][target.destination.x] === null) {
                 let pos = target.piece.position;
                 game.board.grid[pos.y][pos.x] = null;
                 game.board.grid[target.destination.y][target.destination.x] = target.piece;
                 target.piece.position = { ...target.destination };
                 console.log(`«Вспышка Молнии»: фигура ${target.piece.type} перемещена на (${target.destination.x}, ${target.destination.y}).`);
              } else {
                  console.log("Выбрана занятая клетка для перемещения.");
              }
          } else {
              console.log("Выберите свою фигуру для «Вспышки Молнии».");
          }
      }),
      new Card("Призыв Фантома", "Легендарная", (game, player, target) => {
          console.log("«Призыв Фантома»: добавление дополнительной пешки на случайную свободную клетку.");
          let freeCells = [];
          for (let y = 0; y < 8; y++) {
             for (let x = 0; x < 8; x++) {
                if (game.board.grid[y][x] === null) {
                  freeCells.push({ x, y });
                }
             }
          }
          if (freeCells.length > 0) {
             let cell = freeCells[Math.floor(Math.random() * freeCells.length)];
             let pawn = new Piece("Pawn", player);
             pawn.position = { ...cell };
             game.board.grid[cell.y][cell.x] = pawn;
             console.log(`Фантом-пешка добавлена на (${cell.x}, ${cell.y}).`);
          } else {
             console.log("Нет свободной клетки для «Призыва Фантома».");
          }
      }),
      new Card("Темный Вихрь", "Легендарная", (game, player, target) => {
          console.log("«Темный Вихрь»: случайное перемещение всех фигур на одну клетку в одном из направлений.");
          const directions = [
             {dx: -1, dy: 0}, {dx: 1, dy: 0}, {dx: 0, dy: -1}, {dx: 0, dy: 1}
          ];
          for (let y = 0; y < 8; y++) {
             for (let x = 0; x < 8; x++) {
                let piece = game.board.grid[y][x];
                if (piece) {
                   let randomDir = directions[Math.floor(Math.random() * directions.length)];
                   let newX = x + randomDir.dx;
                   let newY = y + randomDir.dy;
                   if (newX >= 0 && newX < 8 && newY >= 0 && newY < 8 && game.board.grid[newY][newX] === null) {
                      game.board.grid[newY][newX] = piece;
                      piece.position = { x: newX, y: newY };
                      game.board.grid[y][x] = null;
                      console.log(`Фигура ${piece.type} перемещена с (${x}, ${y}) на (${newX}, ${newY}).`);
                   }
                }
             }
          }
      }),
      new Card("Коварный Обман", "Редкая", (game, player, target) => {
          console.log("«Коварный Обман» активирован: отмена эффекта вражеской карты на один ход (заглушка).");
          // Для полной реализации потребуется отслеживать активные эффекты.
      }),
      new Card("Магическая Инсталляция", "Эпическая", (game, player, target) => {
          console.log("«Магическая Инсталляция»: комбинирование двух карт для удвоения эффекта (заглушка).");
          // Здесь можно реализовать объединение эффектов двух карт.
      }),
      new Card("Божественный Суд", "Легендарная", (game, player, target) => {
          console.log("«Божественный Суд» активирован: сброс всех ходов и восстановление исходного положения фигур.");
          game.board = new Board();
          game.board.setupPieces(game.player1, game.player2);
      })
    ];

    // Функция для выбора случайной карты с учётом веса редкости
    function drawRandomCard() {
      let totalWeight = cardPool.reduce((sum, card) => sum + rarityWeights[card.rarity], 0);
      let random = Math.random() * totalWeight;
      for (let card of cardPool) {
        random -= rarityWeights[card.rarity];
        if (random < 0) {
          // Возвращаем КОПИЮ карты, чтобы эффекты применялись многократно
          return new Card(card.name, card.rarity, card.effect);
        }
      }
      // На всякий случай возвращаем последнюю карту
      return new Card(
        cardPool[cardPool.length - 1].name,
        cardPool[cardPool.length - 1].rarity,
        cardPool[cardPool.length - 1].effect
      );
    }

    // Класс игрока
    class Player {
      constructor(id, name) {
        this.id = id;
        this.name = name;
        this.mmr = 300;
        this.hand = []; // массив карт
      }

      addCard(card) {
        this.hand.push(card);
        console.log(`${this.name} получил карту: ${card.name} (${card.rarity})`);
      }
    }

    // Класс шахматной фигуры
    class Piece {
      constructor(type, player) {
        this.type = type;
        this.player = player; // объект Player
        this.position = null; // объект { x, y }
        // Дополнительные свойства для эффектов карт
        this.shield = false;
        this.invisible = false;
        this.frozen = false;
        this.protected = false;
      }
    }

    // Класс доски (8x8)
    class Board {
      constructor() {
        this.grid = [];
        for (let i = 0; i < 8; i++) {
          this.grid[i] = new Array(8).fill(null);
        }
      }

      // Устанавливаем стандартное расположение фигур для двух игроков
      setupPieces(player1, player2) {
        const backRank = ["Rook", "Knight", "Bishop", "Queen", "King", "Bishop", "Knight", "Rook"];
        // Игрок 2 (например, чёрные) – верхняя сторона (row 0 и 1)
        for (let j = 0; j < 8; j++) {
          let piece = new Piece(backRank[j], player2);
          piece.position = { x: j, y: 0 };
          this.grid[0][j] = piece;
        }
        for (let j = 0; j < 8; j++) {
          let piece = new Piece("Pawn", player2);
          piece.position = { x: j, y: 1 };
          this.grid[1][j] = piece;
        }
        // Игрок 1 (например, белые) – нижняя сторона (row 6 и 7)
        for (let j = 0; j < 8; j++) {
          let piece = new Piece("Pawn", player1);
          piece.position = { x: j, y: 6 };
          this.grid[6][j] = piece;
        }
        for (let j = 0; j < 8; j++) {
          let piece = new Piece(backRank[j], player1);
          piece.position = { x: j, y: 7 };
          this.grid[7][j] = piece;
        }
      }

      // Простая функция для перемещения фигуры с проверками
      movePiece(fromX, fromY, toX, toY) {
        let piece = this.grid[fromY][fromX];
        if (piece == null) {
          console.log("Нет фигуры для перемещения!");
          return false;
        }
        // Если на целевой клетке есть фигура
        let target = this.grid[toY][toX];
        if (target != null) {
          if (target.player === piece.player) {
            console.log("Нельзя захватывать собственную фигуру!");
            return false;
          } else {
            // Если у противника включен щит – захват невозможен
            if (target.shield) {
              console.log("Противникская фигура защищена щитом!");
              return false;
            }
            console.log(`Фигура ${target.type} игрока ${target.player.name} захвачена!`);
            // Перемещаем фигуру и возвращаем информацию о захваченном объекте
            this.grid[toY][toX] = piece;
            this.grid[fromY][fromX] = null;
            piece.position = { x: toX, y: toY };
            return { captured: target };
          }
        } else {
          // Обычное перемещение
          this.grid[toY][toX] = piece;
          this.grid[fromY][fromX] = null;
          piece.position = { x: toX, y: toY };
          return true;
        }
      }
    }

    // Главный класс игры
    class Game {
      constructor(player1, player2) {
        this.player1 = player1;
        this.player2 = player2;
        this.players = [player1, player2];
        this.board = new Board();
        this.board.setupPieces(player1, player2);
        this.currentPlayerIndex = 0; // 0 – ход первого игрока
        this.turns = 0; // счётчик полных ходов (раунд, когда оба игрока сходили)
      }

      start() {
        console.log("Игра началась!");
        // Раздаём каждому игроку 3 начальные карты
        this.players.forEach(player => {
          for (let i = 0; i < 3; i++) {
            player.addCard(drawRandomCard());
          }
        });
        console.log(`Ход первого игрока: ${this.players[this.currentPlayerIndex].name}`);
      }

      // Завершение хода: добавляем карту каждому игроку и переключаем текущего игрока
      nextTurn() {
        // После завершения раунда (когда оба игрока сходили) даём каждому по одной карте
        this.turns += 1;
        this.players.forEach(player => {
          player.addCard(drawRandomCard());
        });
        this.currentPlayerIndex = (this.currentPlayerIndex + 1) % 2;
        console.log(`Следующий ход: игрок ${this.players[this.currentPlayerIndex].name}`);
      }

      // Метод для перемещения фигуры с доски
      movePiece(fromX, fromY, toX, toY) {
        let result = this.board.movePiece(fromX, fromY, toX, toY);
        if (result && result.captured) {
          // За захват даём карту текущему игроку
          let player = this.players[this.currentPlayerIndex];
          console.log(`${player.name} получил карту за захват фигуры!`);
          player.addCard(drawRandomCard());
        }
        // По окончании хода переходим к следующему
        this.nextTurn();
      }

      // Метод для использования карты из руки (по индексу)
      useCard(player, cardIndex, target) {
        if (player !== this.players[this.currentPlayerIndex]) {
          console.log("Не твой ход для использования карты.");
          return;
        }
        if (cardIndex < 0 || cardIndex >= player.hand.length) {
          console.log("Неверный индекс карты.");
          return;
        }
        let card = player.hand.splice(cardIndex, 1)[0];
        card.use(this, player, target);
      }
    }

    // Пример использования – симуляция игры

    // Создадим двух игроков
    const player1 = new Player(1, "Alice");
    const player2 = new Player(2, "Bob");

    // Инициализируем игру
    const game = new Game(player1, player2);
    game.start();

    // Пример: игрок 1 перемещает пешку с (0,6) на (0,5)
    console.log("\n-- Ход 1: Alice перемещает пешку --");
    game.movePiece(0, 6, 0, 5);

    // Предположим, что теперь Bob (игрок 2) хочет использовать карту
    // Для примера выберем его первую карту (индекс 0)
    console.log("\n-- Ход 2: Bob использует карту --");
    game.useCard(player2, 0, null);

    // Дополнительные симуляции можно добавлять ниже...
  </script>
</body>
</html>
