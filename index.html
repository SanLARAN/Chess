<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–®–∞—Ö–º–∞—Ç—ã —Å –∫–∞—Ä—Ç–∞–º–∏</title>
  <link rel="stylesheet" href="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      text-align: center;
      padding: 20px;
    }
    #board { width: 400px; margin: 0 auto; }
    .hand {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .card {
      background: white;
      border: 2px solid #333;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      max-width: 120px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .card:hover {
      background: #f9f9f9;
    }
    #status {
      margin: 10px;
      font-weight: bold;
    }
    button {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h2>‚ôüÔ∏è –®–∞—Ö–º–∞—Ç—ã —Å –ö–∞—Ä—Ç–∞–º–∏</h2>
  <div id="board"></div>
  <p id="status">–•–æ–¥ –±–µ–ª—ã—Ö</p>
  <button onclick="drawCard()">–í–∑—è—Ç—å –∫–∞—Ä—Ç—É</button>

  <div class="hand" id="hand"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
  <script src="https://unpkg.com/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

  <script>
    const game = new Chess();
    let currentTurn = 'w';
    let extraMove = false;

    const playerState = {
      hand: [],
      frozenPieces: {} // –Ω–∞–ø—Ä–∏–º–µ—Ä: { 'e7': 1 }
    };

    const cardPool = [
      {
        id: "freeze",
        name: "‚ùÑ –ó–∞–º–æ—Ä–æ–∑–∫–∞",
        description: "–ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ—Ç –≤—Ä–∞–∂–µ—Å–∫—É—é —Ñ–∏–≥—É—Ä—É –Ω–∞ 1 —Ö–æ–¥.",
        effect: (targetSquare) => {
          playerState.frozenPieces[targetSquare] = 1;
          alert(`–§–∏–≥—É—Ä–∞ –Ω–∞ ${targetSquare} –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞!`);
        }
      },
      {
        id: "teleport",
        name: "üåÄ –¢–µ–ª–µ–ø–æ—Ä—Ç",
        description: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ —Å–≤–æ—é —Ñ–∏–≥—É—Ä—É –Ω–∞ —Å–≤–æ–±–æ–¥–Ω—É—é –∫–ª–µ—Ç–∫—É.",
        effect: (fromSquare, toSquare) => {
          const piece = game.get(fromSquare);
          if (!piece || piece.color !== currentTurn) {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä —Ñ–∏–≥—É—Ä—ã.");
            return;
          }
          if (game.get(toSquare)) {
            alert("–ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞.");
            return;
          }
          game.remove(fromSquare);
          game.put(piece, toSquare);
          board.position(game.fen());
          alert(`–§–∏–≥—É—Ä–∞ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ ${toSquare}`);
        }
      },
      {
        id: "double_move",
        name: "‚ö° –î–≤–æ–π–Ω–æ–π —Ö–æ–¥",
        description: "–°–¥–µ–ª–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ö–æ–¥ —Å—Ä–∞–∑—É.",
        effect: () => {
          extraMove = true;
          alert("–¢—ã –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω —Ö–æ–¥!");
        }
      }
    ];

    const board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDrop: onDrop
    });

    function onDrop(source, target) {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–º–æ—Ä–æ–∑–∫–∏
      if (playerState.frozenPieces[source]) {
        alert("–≠—Ç–∞ —Ñ–∏–≥—É—Ä–∞ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞!");
        return 'snapback';
      }

      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';

      updateStatus();

      if (!extraMove) switchTurn();
      else extraMove = false;

      board.position(game.fen());
    }

    function switchTurn() {
      currentTurn = currentTurn === 'w' ? 'b' : 'w';

      // –°–Ω–∏–∂–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–º–æ—Ä–æ–∑–∫–∏
      for (const square in playerState.frozenPieces) {
        playerState.frozenPieces[square]--;
        if (playerState.frozenPieces[square] <= 0) delete playerState.frozenPieces[square];
      }

      updateStatus();
    }

    function updateStatus() {
      const status = document.getElementById('status');
      if (game.game_over()) {
        if (game.in_checkmate()) {
          status.textContent = '–ú–∞—Ç!';
        } else if (game.in_draw()) {
          status.textContent = '–ù–∏—á—å—è!';
        } else {
          status.textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.';
        }
      } else {
        status.textContent = `–•–æ–¥ ${currentTurn === 'w' ? '–±–µ–ª—ã—Ö' : '—á—ë—Ä–Ω—ã—Ö'}`;
      }
    }

    function drawCard() {
      const card = JSON.parse(JSON.stringify(cardPool[Math.floor(Math.random() * cardPool.length)]));
      playerState.hand.push(card);
      renderHand();
    }

    function renderHand() {
      const hand = document.getElementById('hand');
      hand.innerHTML = '';

      playerState.hand.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `<strong>${card.name}</strong><br><small>${card.description}</small>`;
        el.onclick = () => useCard(index);
        hand.appendChild(el);
      });
    }

    function useCard(index) {
      const card = playerState.hand[index];
      if (!card) return;

      // –ü—Ä–æ—Å—Ç–æ–π —ç—Ñ—Ñ–µ–∫—Ç
      if (card.id === "freeze") {
        const square = prompt("–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–µ—Ç–∫—É —Å –≤—Ä–∞–∂–µ—Å–∫–æ–π —Ñ–∏–≥—É—Ä–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, e7):");
        if (square) card.effect(square);
      }

      if (card.id === "teleport") {
        const from = prompt("–û—Ç–∫—É–¥–∞ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä, b1)");
        const to = prompt("–ö—É–¥–∞ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä, c3)");
        if (from && to) card.effect(from, to);
      }

      if (card.id === "double_move") {
        card.effect();
      }

      playerState.hand.splice(index, 1);
      renderHand();
    }

    updateStatus();
  </script>
</body>
</html>
